<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>年终总结自动评审 - Web 控制台</title>
  <style>
    :root {
      --bg: #0b1021;
      --panel: #131a2f;
      --accent: #6ce5e8;
      --text: #e7ecff;
      --muted: #9aa3c2;
      --danger: #ff6b6b;
      --success: #5ce38a;
      --border: #1f2942;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #0b1021, #0f1a35 40%, #0b1021);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }
    h1 { margin-top: 0; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      margin-bottom: 16px;
    }
    label { display: block; margin: 8px 0 4px; color: var(--muted); }
    input[type="text"], input[type="number"], input[type="password"], textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0f162a;
      color: var(--text);
    }
    textarea { min-height: 140px; resize: vertical; }
    button {
      background: var(--accent);
      color: #0b1021;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .status { margin-top: 8px; font-size: 13px; color: var(--muted); }
    .links a { color: var(--accent); text-decoration: none; margin-right: 12px; }
    .links a:hover { text-decoration: underline; }
    .chip { background: #1c2742; border: 1px solid var(--border); border-radius: 16px; padding: 6px 10px; font-size: 12px; color: var(--muted); }
    .danger { color: var(--danger); }
    .success { color: var(--success); }
  </style>
</head>
<body>
  <h1>年终总结自动评审 · Web 控制台</h1>

  <div class="card">
    <p>可直接把各部门的文档放到 <code>up_load/</code> 目录，建议按部门/小组分层，比如 <code>up_load/研发/前端/张三.docx</code>。</p>
    <p>提示词可在 <code>prompts/individual/prompt.py</code> 与 <code>prompts/aggregate/prompt.py</code> 中自定义。</p>
  </div>

  <div class="card">
    <h3>运行配置</h3>
    <label>DeepSeek API Key</label>
    <input type="password" id="api-key" placeholder="必填，否则无法调用" />
    <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:8px; margin-top:8px;">
      <div>
        <label>个人提炼模型</label>
        <input type="text" id="model" value="deepseek-chat" />
      </div>
      <div>
        <label>汇总模型</label>
        <input type="text" id="agg-model" value="deepseek-reasoner" />
      </div>
      <div>
        <label>温度 (0.0 - 2.0)</label>
        <input type="number" id="temperature" value="1.3" step="0.1" min="0" max="2" />
      </div>
      <div>
        <label>个人 max_tokens</label>
        <input type="number" id="max-tokens-ind" value="4000" min="4000" max="8192" />
      </div>
      <div>
        <label>汇总 max_tokens</label>
        <input type="number" id="max-tokens-agg" value="32000" min="32000" max="64000" />
      </div>
      <div>
        <label>输入目录（默认 up_load）</label>
        <input type="text" id="input-dir" placeholder="不填则使用 up_load" />
      </div>
    </div>
    <label style="margin-top:8px;">年初计划/指标/背景补充，将直接追加到汇总 prompt</label>
    <textarea id="plan-prompt" placeholder="例如：2025 目标、关键项目、必须覆盖的指标"></textarea>
    <button id="btn-run">开始分析</button>
    <div id="run-status" class="status"></div>
  </div>

  <div class="card">
    <h3>日志 / 结果</h3>
    <label>运行日志</label>
    <textarea id="log-box" readonly></textarea>
    <div class="links" id="result-links"></div>
  </div>

  <script>
    const runStatus = document.getElementById('run-status');
    const logBox = document.getElementById('log-box');
    const resultLinks = document.getElementById('result-links');
    const btnRun = document.getElementById('btn-run');
    const normalize = (p='') => p.replace(/\\/g,'/');

    function setRunStatus(text, cls='') {
      runStatus.textContent = text;
      runStatus.className = 'status ' + cls;
    }
    function appendLog(text) { logBox.value = text; }
    function pushLog(text) { logBox.value += text; logBox.scrollTop = logBox.scrollHeight; }

    btnRun.onclick = async () => {
      const apiKey = document.getElementById('api-key').value.trim();
      if (!apiKey) {
        setRunStatus('请先填写 API Key', 'danger');
        return;
      }
      const payload = {
        api_key: apiKey,
        model: document.getElementById('model').value.trim() || 'deepseek-chat',
        aggregate_model: document.getElementById('agg-model').value.trim() || 'deepseek-reasoner',
        temperature: parseFloat(document.getElementById('temperature').value || '1.3'),
        input_dir: normalize(document.getElementById('input-dir').value.trim()) || 'up_load',
        plan_prompt: document.getElementById('plan-prompt').value.trim() || undefined,
        max_tokens_individual: parseInt(document.getElementById('max-tokens-ind').value || '1100'),
        max_tokens_aggregate: parseInt(document.getElementById('max-tokens-agg').value || '5000'),
      };
      btnRun.disabled = true;
      setRunStatus('运行中...', '');
      appendLog('');
      resultLinks.innerHTML = '';
      try {
        const res = await fetch('/run-stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok || !res.body) throw new Error('流式接口调用失败');
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let doneResult = null;
        while (true) {
          const { value, done } = await reader.read();
          if (value) {
            buffer += decoder.decode(value, { stream: true });
            const parts = buffer.split('\\n\\n');
            buffer = parts.pop() || '';
            for (const chunk of parts) {
              const line = chunk.trim();
              if (!line.startsWith('data:')) continue;
              const payloadStr = line.slice(5).trim();
              try {
                const evt = JSON.parse(payloadStr);
                if (evt.type === 'log') {
                  pushLog(evt.message || '');
                } else if (evt.type === 'done') {
                  doneResult = evt;
                } else if (evt.type === 'error') {
                  throw new Error(evt.message || '运行错误');
                }
              } catch (err) {
                console.error('解析事件失败', err, line);
              }
            }
          }
          if (done) break;
        }
        if (buffer) {
          for (const chunk of buffer.split('\\n\\n')) {
            const line = chunk.trim();
            if (!line.startsWith('data:')) continue;
            const payloadStr = line.slice(5).trim();
            try {
              const evt = JSON.parse(payloadStr);
              if (evt.type === 'log') {
                pushLog(evt.message || '');
              } else if (evt.type === 'done') {
                doneResult = evt;
              } else if (evt.type === 'error') {
                throw new Error(evt.message || '运行错误');
              }
            } catch (err) {
              console.error('解析事件失败', err, line);
            }
          }
        }
        if (doneResult) {
          let linksHtml = '';
          if (doneResult.individual) {
            linksHtml += `<a href="/download?path=${encodeURIComponent(doneResult.individual)}" target="_blank">下载 individual_summaries.json</a>`;
          }
          if (doneResult.organization) {
            linksHtml += `<a href="/download?path=${encodeURIComponent(doneResult.organization)}" target="_blank">下载 organization_review.md</a>`;
          }
          linksHtml += `<span class="chip">运行目录: ${doneResult.run_dir || 'N/A'}</span>`;
          resultLinks.innerHTML = linksHtml;
          if (doneResult.exit_code === 0) {
            setRunStatus('完成', 'success');
          } else {
            setRunStatus(`退出码 ${doneResult.exit_code}`, 'danger');
          }
        } else {
          setRunStatus('运行结束但未返回结果', 'danger');
        }
      } catch (e) {
        setRunStatus(e.message, 'danger');
        console.error(e);
      } finally {
        btnRun.disabled = false;
      }
    };
  </script>
</body>
</html>
